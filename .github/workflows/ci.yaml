name: CI

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

env:
    GODOT_VERSION: "4.6.0"

jobs:
    tests:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Godot
              uses: chickensoft-games/setup-godot@v2
              with:
                  version: ${{ env.GODOT_VERSION }}
                  use-dotnet: false

            - name: Run tests
              run: |
                  godot --headless --import
                  godot --headless --path . -s addons/gut/gut_cmdln.gd -gconfig res://tests/gutconfig.json

    analyze:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Godot
              uses: chickensoft-games/setup-godot@v2
              with:
                  version: ${{ env.GODOT_VERSION }}
                  use-dotnet: false

            - name: Run Code Analysis
              run: |
                  godot --headless --import
                  godot --headless --script res://addons/gdscript-linter/analyzer/analyze-cli.gd

    lint:
        runs-on: ubuntu-latest
        env:
            FORMATTER_URL: "https://api.github.com/repos/GDQuest/GDScript-formatter/releases/latest"
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Download GDScript Formatter
              run: |
                  release=$(curl -s ${{ env.FORMATTER_URL }})

                  echo "Available assets:"
                  echo "$release" | jq -r '.assets[].name' >&2

                  url=$(echo "$release" \
                    | jq -r '.assets[]
                        | select(.name | test("linux"; "i"))
                        | select(.name | test("x86_64"; "i"))
                        | .browser_download_url' \
                    | head -n 1)

                  if [ -z "$url" ] || [ "$url" = "null" ]; then
                      echo "❌ No Linux asset found in the latest release"
                      exit 1
                  fi

                  echo "Downloading: $url"
                  curl -L "$url" -o formatter.zip

                  mkdir gdformatter
                  unzip -q formatter.zip -d gdformatter

                  # Find binary and add to PATH
                  bin=$(find gdformatter -type f | head -n 1)

                  if [ -z "$bin" ]; then
                      echo "❌ gdscript-formatter binary not found"
                      exit 1
                  fi

                  chmod +x "$bin"
                  echo "$(dirname "$bin")" >> $GITHUB_PATH
                  echo "FORMATTER_BIN=$(basename "$bin")" >> $GITHUB_ENV

            - name: Lint
              shell: bash
              run: |
                  echo "Formatter name: $FORMATTER_BIN"

                  mapfile -t files < <(find . -type f -name "*.gd" \
                      -not -path "*/addons/*" \
                      -not -path "*/build/*" \
                      -not -path "*/.git/*")

                  if [ ${#files[@]} -eq 0 ]; then
                      echo "No .gd files found (after exclusions)."
                      exit 0
                  fi

                  "$FORMATTER_BIN" lint --max-line-length 144 --pretty "${files[@]}"
